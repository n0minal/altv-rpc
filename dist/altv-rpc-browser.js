(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):(a="undefined"==typeof globalThis?a||self:globalThis,b(a.rpc={}))})(this,function(a){'use strict';function b(){const a=0|46656*Math.random(),b=0|46656*Math.random(),c=("000"+a.toString(36)).slice(-3),d=("000"+b.toString(36)).slice(-3);return c+d}function c(){if(!alt.Player)return"cef";return alt.Player.local?"client":alt.Player?"server":void 0}function d(a){const b=c();return JSON.stringify(a,(a,c)=>("client"===b||"server"===b)&&c instanceof alt.Entity?{__i:c.id}:c)}function e(a){const b=c();try{return JSON.parse(a,(a,c)=>("client"===b||"server"===b)&&c&&"object"==typeof c&&"number"==typeof c.__i&&1===Object.keys(c).length?alt.Entity.getByID(c.__i):c)}catch(b){h(`Failed to parse event arguments: ${b.message}`,!0),h(a,!0)}}function f(a,b){return"number"==typeof b?Promise.race([new Promise((a,c)=>{K(()=>c("TIMEOUT"),b)}),a]):a}function g(a){const b="__rpc:namespaces",c=(a,b)=>{if(!a.includes(b))return a.push(b),!0};if(J){const d=J[b]||[];if(!c(d,a))return!1;J[b]=d}else{const d=alt.Player.local;if(d){const e=d.getMeta(b),f=e?JSON.parse(e):[];if(!c(f,a))return!1;d.setMeta(b,JSON.stringify(f))}}return!0}function h(a,b=!1){const d=c();(b||!1)&&(alt.log||console.log)(`RPC (${d}): ${a}`)}function i(a){return a.match(/.{1,10000}/g)}function j(a){if(Z)throw"Already initialized.";if(!a)throw"Must specify a namespace.";if(!g(a))throw`Namespace "${a}" is already in use.`;h(`Initialized with namespace "${a}"`),Z=a;const b=k(N),c=k(P);alt.on(b,m),"server"===L&&alt.onClient(b,(a,b)=>m(b,a)),"client"===L&&(alt.onServer(b,m),q("__rpc:callServer",([a,b,c],d)=>t(a,b,{fenv:d.environment,noRet:c})),q("__rpc:callBrowsers",([a,b,c],d)=>y(null,a,b,{fenv:d.environment,noRet:c})),q(k(Q),([a,b],d)=>{W.forEach(e=>{x(e,c,[a,b],{fenv:d.environment,noRet:1})})})),q(c,([a,b],c)=>B(a,b,c))}function k(a){return`${a}::${Z}`}function l(){if(!Z)throw new Error(`You must first call rpc.init() with a namespace.`)}function m(a,b,c){h(`Processing Event: ${a.id} (${a.part}/${a.total})${b?" from player":""}${c?" from cef":""}`);const d=U[a.id]||{recv:0,total:a.total};if("undefined"!=typeof a.args&&(!d.args&&(d.args=""),d.args+=a.args),d.recv++,U[a.id]=d,d.recv<d.total)return;delete U[a.id],h(`Stringified Args: ${d.args}`);const f="undefined"==typeof d.args?void 0:e(d.args),g=k(N);if(a.type===R.REQUEST){const d={id:a.id,environment:a.fenv||a.env,player:b};let e,h=!0;switch(L){case"server":e=a=>alt.emitClient(b,g,a);break;case"client":{"server"===a.env?e=a=>alt.emitServer(g,a):"cef"===a.env&&(d.browser=c,e=a=>c&&c.valid&&c.emit(g,a));break}case"cef":e=a=>alt.emit(N,a),h=!1;}if(e){const b=n(a.name,f,d);if(!a.noRet){let c,d=R.RESPONSE_SUCCESS;b.then(a=>{c=a}).catch(a=>{d=R.RESPONSE_ERROR,c=a}).finally(()=>{o({type:d,id:a.id,env:L},c,e,h)})}}}else{const c=T[a.id];if("server"===L&&c.player!==b)return;c&&(c.resolve(a.type===R.RESPONSE_SUCCESS?f:Promise.reject(f)),delete T[a.id])}}async function n(a,b,c){const d=S[a];if(!d)throw`${M} (${a})`;return d(b,c)}function o(a,b,c,e=!0){const f=(b,d,e)=>c({...a,part:b,total:d,args:e});if("undefined"!=typeof b){const a=d(b),c=e?i(a):[a];c.forEach((a,b)=>{f(b+1,c.length,a)})}else f(1,1)}function p(a){if(l(),"client"!==L)throw"addWebView can only be used on the client";W.includes(a)||(a.on(N,b=>m(b,void 0,a)),a.on(O,b=>{X[b]=a}),W.push(a))}function q(a,b){if(2!==arguments.length)throw"register expects 2 arguments: \"name\" and \"cb\"";h(`Registered procedure "${a}"`),"cef"===L&&alt.emit(O,a),S[a]=b}function r(a){if(1!==arguments.length)throw"unregister expects 1 argument: \"name\"";S[a]=void 0}function s(a,b,c={}){return 1>arguments.length||3<arguments.length?Promise.reject("call expects 1 to 3 arguments: \"name\", optional \"args\", and optional \"options\""):f(n(a,b,{environment:L}),c.timeout)}function t(a,c,d={}){switch(l(),L){case"server":return s(a,c);case"client":{const e=b();return new Promise(b=>{d.noRet||(T[e]={resolve:b}),o({type:R.REQUEST,id:e,name:a,env:L,...d},c,a=>alt.emitServer(k(N),a))})}case"cef":return w("__rpc:callServer",[a,c,+d.noRet]);}}function u(a,b,c={}){if(l(),1>arguments.length||3<arguments.length)return Promise.reject("callServer expects 1 to 3 arguments: \"name\", optional \"args\", and optional \"options\"");let d={};return c.noRet&&(d.noRet=1),f(t(a,b,d),c.timeout)}function v(a,c,d,e={}){switch(l(),L){case"client":return s(c,d);case"server":{const f=b();return new Promise(b=>{e.noRet||(T[f]={resolve:b,player:a}),o({type:R.REQUEST,id:f,name:c,env:L,...e},d,b=>alt.emitClient(a,k(N),b))})}case"cef":{const a=b();return new Promise(b=>{e.noRet||(T[a]={resolve:b}),o({type:R.REQUEST,id:a,name:c,env:L,...e},d,a=>alt.emit(N,a),!1)})}}}function w(a,b,c,d={}){switch(l(),L){case"client":{if(d=c||{},c=b,b=a,a=null,1>arguments.length||3<arguments.length||"string"!=typeof b)return Promise.reject("callClient from the client expects 1 to 3 arguments: \"name\", optional \"args\", and optional \"options\"");break}case"server":{if(2>arguments.length||4<arguments.length||"object"!=typeof a)return Promise.reject("callClient from the server expects 2 to 4 arguments: \"player\", \"name\", optional \"args\", and optional \"options\"");break}case"cef":{if(d=c||{},c=b,b=a,a=null,1>arguments.length||3<arguments.length||"string"!=typeof b)return Promise.reject("callClient from the browser expects 1 to 3 arguments: \"name\", optional \"args\", and optional \"options\"");break}}let e={};return d.noRet&&(e.noRet=1),f(v(a,b,c,e),d.timeout)}function x(a,c,d,e={}){return a&&a.valid?(l(),new Promise(f=>{const g=b();e.noRet||(T[g]={resolve:f}),o({type:R.REQUEST,id:g,name:c,env:L,...e},d,b=>a.emit(k(N),b),!1)})):Promise.reject("INVALID_BROWSER")}function y(a,b,c,d={}){switch(l(),L){case"client":const e=X[b];return e&&e.valid?x(e,b,c,d):Promise.reject(`${M} (${b})`);case"server":return v(a,"__rpc:callBrowsers",[b,c,+d.noRet],d);case"cef":return v(null,"__rpc:callBrowsers",[b,c,+d.noRet],d);}}function z(a,b,c,d={}){l();let e,g={};switch(L){case"client":case"cef":if(d=c||{},c=b,b=a,1>arguments.length||3<arguments.length)return Promise.reject("callBrowsers from the client or browser expects 1 to 3 arguments: \"name\", optional \"args\", and optional \"options\"");d.noRet&&(g.noRet=1),e=y(null,b,c,g);break;case"server":if(2>arguments.length||4<arguments.length)return Promise.reject("callBrowsers from the server expects 2 to 4 arguments: \"player\", \"name\", optional \"args\", and optional \"options\"");d.noRet&&(g.noRet=1),e=y(a,b,c,g);}if(e)return f(e,d.timeout)}function A(a,b,c,d={}){if("client"!==L)return Promise.reject("callBrowser can only be used in the client environment");if(2>arguments.length||4<arguments.length)return Promise.reject("callBrowser expects 2 to 4 arguments: \"browser\", \"name\", optional \"args\", and optional \"options\"");l();let e={};return d.noRet&&(e.noRet=1),f(x(a,b,c,e),d.timeout)}function B(a,b,c){const d=V[a];d&&d.forEach(a=>a(b,c))}function C(a,b){if(2!==arguments.length)throw"on expects 2 arguments: \"name\" and \"cb\"";const c=V[a]||new Set;c.add(b),V[a]=c}function D(a,b){if(2!==arguments.length)throw"off expects 2 arguments: \"name\" and \"cb\"";const c=V[a];c&&c.delete(b)}function E(a,b){if(1>arguments.length||2<arguments.length)throw"trigger expects 1 or 2 arguments: \"name\", and optional \"args\"";B(a,b,{environment:L})}function F(a,b,c){switch(l(),L){case"client":{if(c=b,b=a,a=null,1>arguments.length||2<arguments.length||"string"!=typeof b)throw"triggerClient from the client expects 1 or 2 arguments: \"name\", and optional \"args\"";break}case"server":{if(2>arguments.length||3<arguments.length||"object"!=typeof a)throw"triggerClient from the server expects 2 or 3 arguments: \"player\", \"name\", and optional \"args\"";break}case"cef":{if(c=b,b=a,a=null,1>arguments.length||2<arguments.length||"string"!=typeof b)throw"triggerClient from the browser expects 1 or 2 arguments: \"name\", and optional \"args\"";break}}v(a,k(P),[b,c],{noRet:1})}function G(a,b){if(1>arguments.length||2<arguments.length)throw"triggerServer expects 1 or 2 arguments: \"name\", and optional \"args\"";l(),t(k(P),[a,b],{noRet:1})}function H(a,b,c){switch(L){case"client":case"cef":if(c=b,b=a,a=null,1>arguments.length||2<arguments.length)throw"triggerBrowsers from the client or browser expects 1 or 2 arguments: \"name\", and optional \"args\"";break;case"server":if(2>arguments.length||3<arguments.length)throw"triggerBrowsers from the server expects 2 or 3 arguments: \"player\", \"name\", and optional \"args\"";}l(),v(a,k(Q),[b,c],{noRet:1})}function I(a,b,c){if("client"!==L)throw"callBrowser can only be used in the client environment";if(2>arguments.length||4<arguments.length)throw"callBrowser expects 2 or 3 arguments: \"browser\", \"name\", and optional \"args\"";l(),x(a,k(P),[b,c],{noRet:1})}const J=function(){if("undefined"!=typeof global)return global;return"undefined"==typeof window?void 0:window}(),K=alt.setTimeout||J.setTimeout,L=c();if(!L)throw"Unknown alt:V environment";const M="PROCEDURE_NOT_FOUND",N="__rpc:process",O="__rpc:browserRegister",P="__rpc:triggerEvent",Q="__rpc:triggerEventBrowsers";var R;(function(a){a[a.REQUEST=0]="REQUEST",a[a.RESPONSE_SUCCESS=1]="RESPONSE_SUCCESS",a[a.RESPONSE_ERROR=2]="RESPONSE_ERROR"})(R||(R={}));const S={},T={},U={},V={},W=[],X={},Y=new Map;let Z="";const $=()=>function(a){return class extends a{constructor(...b){if(super(...b),!Reflect.getMetadata("design:procedurelist:init",a.prototype)){const b=Reflect.getMetadata("design:procedurelist",a.prototype)||[];b.forEach((a,b)=>{a=a.map(a=>{const{procedure:c,callable:d}=a,e=this[d].bind(this);if("function"!=typeof this[d])throw new Error(`Event[${b}] in ${this.constructor.name} is not callable!`);return c.forEach(a=>q(a,e)),a.func=e,a});const c=Y.get(b)||[];Y.set(b,[...c,...a])}),Reflect.defineMetadata("design:procedurelist:init",!0,a.prototype)}}}},_=a=>{a=Array.isArray(a)?a:[a];const b=a.filter((b,c)=>a.indexOf(b)===c),c={procedure:b,callable:""},d=b[0];return function(a,b,e){if(!(e.value instanceof Function))throw new Error(`Procedure[${d}] must be callable`);const f=Reflect.getMetadata("design:procedurelist",a)||new Map;c.callable=b.toString();const g=f.get(d);return f.set(d,g&&[...g,c]||[c]),Reflect.defineMetadata("design:procedurelist",f,a),e}};a.addWebView=p,a.call=s,a.callBrowser=A,a.callBrowsers=z,a.callClient=w,a.callServer=u,a.default={init:j,addWebView:p,register:q,unregister:r,call:s,callServer:u,callClient:w,callBrowsers:z,callBrowser:A,on:C,off:D,trigger:E,triggerServer:G,triggerClient:F,triggerBrowsers:H,triggerBrowser:I,procedurable:$,procedure:_},a.init=j,a.off=D,a.on=C,a.procedurable=$,a.procedure=_,a.register=q,a.trigger=E,a.triggerBrowser=I,a.triggerBrowsers=H,a.triggerClient=F,a.triggerServer=G,a.unregister=r,Object.defineProperty(a,"__esModule",{value:!0})});
